{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Usage visualization  - Apps",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"eeec0383-08ac-4fd3-8a04-8f35e8e5b1d8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isGlobal\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":604800000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Process_ProcessDetail_CL\\r\\n| where SessionID_d  > 0\\r\\n| where isnotempty(AppId_s)\\r\\n| where AppId_s !contains \\\"OS\\\" \\r\\n| summarize \\r\\n    AppNameCount = dcount(AppId_s),\\r\\n    VersionCount = dcount(AppVersion_s),\\r\\n    UserCount = dcount(ProcUser_s),\\r\\n    HostCount = dcount(Computer)\",\"size\":3,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"labelSettings\":[{\"columnId\":\"AppNameCount\",\"label\":\"#Applications:\"},{\"columnId\":\"VersionCount\",\"label\":\"#Versions:\"},{\"columnId\":\"UserCount\",\"label\":\"#Users:\"},{\"columnId\":\"HostCount\",\"label\":\"#Hosts:\"}]}},\"name\":\"query - 0\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Session_SessionDetail_CL\\r\\n| summarize Count = count() by bin(TimeGenerated, 30m), SessionFgAppId_s \\r\\n| evaluate pivot(SessionFgAppId_s, sum(Count))\\r\\n| extend PackedColumns = pack_all()\\r\\n| extend RowTotal = 0\\r\\n| mv-apply PackedColumns on (\\r\\n    extend KeyValue = todynamic(PackedColumns)\\r\\n    | mv-expand KeyValue\\r\\n    | extend Key = tostring(bag_keys(KeyValue)[0]), Value = todouble(KeyValue[tostring(bag_keys(KeyValue)[0])])\\r\\n    | where Key != \\\"TimeGenerated\\\" and isnotnull(Value)\\r\\n    | summarize RowTotal = sum(Value)\\r\\n)\\r\\n| extend Percentages = pack_all()\\r\\n| mv-apply Percentages on (\\r\\n    extend KeyValue = todynamic(Percentages)\\r\\n    | mv-expand KeyValue\\r\\n    | extend Key = tostring(bag_keys(KeyValue)[0]), Value = todouble(KeyValue[tostring(bag_keys(KeyValue)[0])])\\r\\n    | where Key != \\\"TimeGenerated\\\" and Key != \\\"RowTotal\\\" and isnotnull(Value)\\r\\n    | extend Percentage = round(Value * 100.0 / RowTotal, 1)\\r\\n    | summarize make_bag(pack(Key, Percentage))\\r\\n)\\r\\n| evaluate bag_unpack(bag_, \\\"Percent_\\\")\\r\\n| project-keep TimeGenerated, Percent*\\r\\n| project-away Percent__Empty\\r\\n| extend PackedColumns = pack_all()\\r\\n| extend RowTotal = 0\\r\\n| mv-apply PackedColumns on (\\r\\n    extend KeyValue = todynamic(PackedColumns)\\r\\n    | mv-expand KeyValue\\r\\n    | extend Key = tostring(bag_keys(KeyValue)[0]), Value = todouble(KeyValue[tostring(bag_keys(KeyValue)[0])])\\r\\n    | where Key != \\\"TimeGenerated\\\" and isnotnull(Value)\\r\\n    | summarize RowTotal = sum(Value)\\r\\n)\\r\\n| extend Percentages = pack_all()\\r\\n| mv-apply Percentages on (\\r\\n    extend KeyValue = todynamic(Percentages)\\r\\n    | mv-expand KeyValue\\r\\n    | extend Key = tostring(bag_keys(KeyValue)[0]), Value = todouble(KeyValue[tostring(bag_keys(KeyValue)[0])])\\r\\n    | where Key != \\\"TimeGenerated\\\" and Key != \\\"RowTotal\\\" and isnotnull(Value)\\r\\n    | extend Percentage = round(Value * 100.0 / RowTotal, 1)\\r\\n    | summarize make_bag(pack(Key, Percentage))\\r\\n)\\r\\n| evaluate bag_unpack(bag_, \\\"_\\\")\\r\\n| project-keep TimeGenerated, _Percent*\",\"size\":0,\"title\":\"Foreground application over time (%)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"name\":\"query - 1\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet TotalCount = toscalar(\\r\\n    uberAgent_Session_SessionDetail_CL\\r\\n    | where isnotempty(SessionFgAppId_s)\\r\\n    | summarize TotalCount = count()\\r\\n);\\r\\nuberAgent_Session_SessionDetail_CL\\r\\n| where isnotempty( SessionFgAppId_s)\\r\\n| summarize CountSessionFgAppName = count() by SessionFgAppId_s\\r\\n| extend [\\\"App in foreground (%)\\\"] = round(CountSessionFgAppName * 100.0 / TotalCount, 1)\\r\\n| project SessionFgAppId_s, [\\\"App in foreground (%)\\\"]\\r\\n| order by [\\\"App in foreground (%)\\\"] desc\\r\\n| top 10 by [\\\"App in foreground (%)\\\"]\",\"size\":0,\"title\":\"Foreground application (top 10)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showMetrics\":false,\"xSettings\":{\"label\":\"\"},\"ySettings\":{\"label\":\"App in foreground (%)\"}}},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet TotalCount = toscalar(\\r\\n    uberAgent_Session_SessionDetail_CL\\r\\n    | where isnotempty(SessionFgProcessName_s)\\r\\n    | summarize TotalCount = count()\\r\\n);\\r\\nuberAgent_Session_SessionDetail_CL\\r\\n| where isnotempty(SessionFgProcessName_s)\\r\\n| summarize CountSessionFgProcessName = count() by SessionFgProcessName_s\\r\\n| extend [\\\"Process in foreground (%)\\\"] = round(CountSessionFgProcessName * 100.0 / TotalCount, 1)\\r\\n| project SessionFgProcessName_s, [\\\"Process in foreground (%)\\\"]\\r\\n| order by [\\\"Process in foreground (%)\\\"] desc\\r\\n| top 10 by [\\\"Process in foreground (%)\\\"]\",\"size\":0,\"title\":\"Foreground process (top 10)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showMetrics\":false,\"ySettings\":{\"label\":\"Process in foreground (%)\"}}},\"customWidth\":\"50\",\"name\":\"query - 3\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Process_ProcessDetail_CL\\r\\n| where SessionID_d > 0\\r\\n| where isnotempty(AppId_s)\\r\\n| where AppId_s !contains \\\"OS\\\"\\r\\n| summarize [\\\"#Users\\\"] = dcount(ProcUser_s) by AppId_s\\r\\n| order by [\\\"#Users\\\"] desc\\r\\n| top 10 by [\\\"#Users\\\"]\\r\\n| project Name = AppId_s, [\\\"#Users\\\"]\",\"size\":0,\"title\":\"Number of users running an application (top 10)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"group\":null,\"createOtherGroup\":0,\"showMetrics\":false,\"ySettings\":{\"label\":\"#Users\"}}},\"customWidth\":\"50\",\"name\":\"query - 5\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Process_ProcessDetail_CL\\r\\n| where SessionID_d > 0\\r\\n| where isnotempty(AppId_s)\\r\\n| where AppId_s !contains \\\"OS\\\"\\r\\n| summarize [\\\"#Hosts\\\"] = dcount(Computer) by AppId_s\\r\\n| order by [\\\"#Hosts\\\"] desc\\r\\n| top 10 by [\\\"#Hosts\\\"]\\r\\n| project Name = AppId_s, [\\\"#Hosts\\\"]\",\"size\":0,\"title\":\"Number of computers running an application (top 10)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"group\":null,\"createOtherGroup\":0,\"showMetrics\":false,\"ySettings\":{\"label\":\"#Hosts\"}}},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Process_ProcessDetail_CL\\r\\n| where SessionID_d > 0\\r\\n| where isnotempty(AppId_s)\\r\\n| where AppId_s !contains \\\"OS\\\"  \\r\\n| summarize [\\\"#Versions\\\"] = dcount(AppVersion_s), [\\\"#Users\\\"] = dcount(ProcUser_s), [\\\"#Hosts\\\"] = dcount(Computer) by AppId_s\\r\\n| extend sortfield = tolower(AppId_s)\\r\\n| order by sortfield asc\\r\\n| project Name = AppId_s, [\\\"#Versions\\\"], [\\\"#Users\\\"], [\\\"#Hosts\\\"]\",\"size\":0,\"title\":\"Application usage\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"70%\"}},{\"columnMatch\":\"#Versions\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"10%\"}},{\"columnMatch\":\"#Users\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"10%\"}},{\"columnMatch\":\"#Hosts\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"10%\"}}],\"filter\":true}},\"name\":\"query - 7\",\"styleSettings\":{\"showBorder\":true}}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/6acb58f7-163b-48ff-b133-8c258b4f14da/resourceGroups/KRS-RG1/providers/Microsoft.OperationalInsights/workspaces/uberAgentWS\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}