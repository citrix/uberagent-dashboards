{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Usage visualization - Machines",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"3816bcb6-7fcc-487c-ac73-a893d845a6b6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":604800000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet SiteCount = uberAgent_Citrix_Machines_CL\\r\\n| where SiteGuid_g != \\\"\\\"\\r\\n| summarize SiteCount = dcount(SiteGuid_g), sl=1;\\r\\n\\r\\nlet VDAStats = uberAgent_Citrix_Machines_CL\\r\\n| extend isVDA = iff(MachineRole_d in (0, 2), 1, 0)\\r\\n| extend isDDC = iff(MachineRole_d in (1, 2), 1, 0)\\r\\n| extend isRegistered = iff(CurrentRegistrationState_d == 1, 1, 0)\\r\\n| where isVDA == 1 and isnotempty(SiteGuid_g) and isnotempty(NameHost_s)\\r\\n| summarize \\r\\n    CatalogId = arg_max(TimeGenerated, CatalogId_g),\\r\\n    DesktopGroupId = arg_max(TimeGenerated, DesktopGroupId_g),\\r\\n    IsRegisteredNumber = arg_max(TimeGenerated, isRegistered)\\r\\n    by Id_g\\r\\n| extend HasDeliveryGroup = iff(isnotempty(DesktopGroupId), 1, 0)\\r\\n| project CatalogId, DesktopGroupId, HasDeliveryGroup, isRegistered\\r\\n| summarize \\r\\n    VDACount = count(),\\r\\n    VDAsWithDeliveryGroup = sum(HasDeliveryGroup),\\r\\n    RegisteredCount = sum(isRegistered)\\r\\n| extend \\r\\n    UnregisteredCount = VDACount - RegisteredCount,\\r\\n    RegisteredPercent =  round(RegisteredCount * 100.0 / VDACount, 1),\\r\\n    sl = 1;\\r\\n\\r\\n\\r\\nlet DDCCount = uberAgent_Citrix_Machines_CL\\r\\n| extend isDDC = iff(MachineRole_d in (1, 2), 1, 0)\\r\\n| where isDDC == 1 and isnotempty(SiteGuid_g)\\r\\n| summarize DDCCount = count(), sl=1;\\r\\n\\r\\nlet CatalogCount = uberAgent_Citrix_Catalogs_CL\\r\\n| where SiteGuid_g != \\\"\\\" and Id_g != \\\"\\\"\\r\\n| summarize CatalogCount = dcount(Id_g), sl=1;\\r\\n\\r\\nlet DeliveryGroupCount = uberAgent_Citrix_DesktopGroups_CL\\r\\n| where SiteGuid_g != \\\"\\\" and Id_g != \\\"\\\"\\r\\n| summarize DeliveryGroupCount = dcount(Id_g), sl=1;\\r\\n\\r\\nSiteCount\\r\\n| join kind=inner (VDAStats) on $left.sl == $right.sl\\r\\n| join kind=inner (DDCCount) on $left.sl == $right.sl\\r\\n| join kind=inner (CatalogCount) on $left.sl == $right.sl\\r\\n| join kind=inner (DeliveryGroupCount) on $left.sl == $right.sl\\r\\n| project SiteCount, CatalogCount, DeliveryGroupCount, DDCCount, VDACount, VDAsWithDeliveryGroup, RegisteredCount, UnregisteredCount, RegisteredPercent\\r\\n\",\"size\":3,\"title\":\"Overview\",\"noDataMessage\":\"No results found\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DDCCount\",\"formatter\":1},{\"columnMatch\":\"RegisteredPercent\",\"formatter\":0,\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"SiteGuid_g\",\"formatter\":5}],\"rowLimit\":1,\"labelSettings\":[{\"columnId\":\"SiteCount\",\"label\":\"#Sites:\"},{\"columnId\":\"CatalogCount\",\"label\":\"#Machine Catalogs:\"},{\"columnId\":\"DeliveryGroupCount\",\"label\":\"#Delivery groups\"},{\"columnId\":\"VDACount\",\"label\":\"#VDAs total\"},{\"columnId\":\"VDAsWithDeliveryGroup\",\"label\":\"#VDA with delivery group:\"},{\"columnId\":\"RegisteredCount\",\"label\":\"#Registered VDA\"},{\"columnId\":\"UnregisteredCount\",\"label\":\"#Unregistered VDAs:\"},{\"columnId\":\"RegisteredPercent\",\"label\":\"%Registered VDAs\"}]}},\"name\":\"query - 0\"}]},\"name\":\"group - Overview\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Machine registration count over time\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"38931e24-539c-4090-af51-a6dc900527ba\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"GroupBy_Machine\",\"label\":\"Group by:\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\": \\\"CatalogDisplayName_s\\\", \\\"label\\\": \\\"Machine catalog\\\"},\\r\\n{\\\"value\\\": \\\"DesktopGroupDisplayName_s\\\", \\\"label\\\": \\\"Delivery group\\\"}]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"CatalogDisplayName_s\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Citrix_Machines_CL\\r\\n| extend isRegistered = iff(CurrentRegistrationState_d == 1, 1, 0)\\r\\n| where isRegistered == 1 and isnotempty(SiteGuid_g) and isnotempty(CatalogId_g) and isnotempty(DesktopGroupId_g) and isnotempty(NameHost_s)\\r\\n| summarize RegisteredCount = dcount(Id_g) by {GroupBy_Machine}, bin(TimeGenerated, 1m)\\r\\n| project TimeGenerated, {GroupBy_Machine}, RegisteredCount\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"name\":\"MachineRegistration\"}]},\"customWidth\":\"50\",\"name\":\"group - 9\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"User session count over time\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a6397945-87f6-4e2a-b391-2ca5b8d4c354\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"GroupBy_Session\",\"label\":\"Group by:\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\"[{\\\"value\\\": \\\"CatalogDisplayName_s\\\", \\\"label\\\": \\\"Machine catalog\\\"},\\r\\n{\\\"value\\\": \\\"DesktopGroupDisplayName_s\\\", \\\"label\\\": \\\"Delivery group\\\"}]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"DesktopGroupDisplayName_s\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nuberAgent_Citrix_Machines_CL \\r\\n| extend isVDA = iff(MachineRole_d in (0, 2), 1, 0)\\r\\n| where \\r\\n    isVDA == 1 and \\r\\n     SiteGuid_g != \\\"\\\" and CatalogId_g != \\\"\\\" and DesktopGroupId_g != \\\"\\\"\\r\\n| summarize CurrentSessionCount = avg(CurrentSessionCount_d), CatalogDisplayName = arg_max({GroupBy_Session}, TimeGenerated) by bin(TimeGenerated, 1m), Id_g\\r\\n| summarize CurrentSessionCount = sum(CurrentSessionCount) by bin(TimeGenerated, 1m), CatalogDisplayName\\r\\n| project TimeGenerated, CatalogDisplayName, CurrentSessionCount\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true,\"seriesLabelSettings\":[{\"seriesName\":\"RdsDesktopAndAppGroup\",\"color\":\"greenDark\"},{\"seriesName\":\"VdiDesktopGroup\",\"color\":\"brown\"}]}},\"name\":\"query - 11\"}]},\"customWidth\":\"50\",\"name\":\"group - 10\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let CatalogDetails = uberAgent_Citrix_Catalogs_CL \\r\\n| where isnotempty(SiteGuid_g) and isnotempty(Id_g)\\r\\n| extend ProvisioningTypeDisplayName = case(ProvisioningType_d == 0, \\\"Unknown\\\", \\r\\n                       ProvisioningType_d == 1, \\\"MCS\\\", \\r\\n                       ProvisioningType_d == 2, \\\"PVS\\\", \\r\\n                       ProvisioningType_d == 3, \\\"Manual\\\", \\r\\n                       \\\"NotSupported\\\")\\r\\n| extend SessionSupportDisplayName = case(SessionSupport_d == 0, \\\"Unknown\\\", \\r\\n                       SessionSupport_d == 1, \\\"SingleSession\\\", \\r\\n                       SessionSupport_d == 2, \\\"MultiSession\\\", \\r\\n                       \\\"NotSupported\\\")\\r\\n| extend AllocationTypeDisplayName = case(AllocationType_d == 0, \\\"Unknown\\\", \\r\\n                       AllocationType_d == 1, \\\"Static\\\", \\r\\n                       AllocationType_d == 2, \\\"Random\\\", \\r\\n                       AllocationType_d == 3, \\\"Permanent\\\", \\r\\n                       \\\"NotSupported\\\")\\r\\n| extend PersistentUserChangesDisplayName = case(PersistentUserChanges_d == 0, \\\"Unknown\\\", \\r\\n                       PersistentUserChanges_d == 1, \\\"Discard\\\", \\r\\n                       PersistentUserChanges_d == 2, \\\"OnLocal\\\", \\r\\n                       PersistentUserChanges_d == 3, \\\"OnPvd\\\", \\r\\n                       \\\"NotSupported\\\")\\r\\n| summarize \\r\\n     arg_max(TimeGenerated, Name_s),\\r\\n    arg_max(TimeGenerated, ProvisioningTypeDisplayName),\\r\\n    arg_max(TimeGenerated, SessionSupportDisplayName),\\r\\n     arg_max(TimeGenerated, AllocationTypeDisplayName),\\r\\n    arg_max(TimeGenerated, PersistentUserChangesDisplayName)\\r\\n    \\r\\nby Id_g\\r\\n| project CatalogId = Id_g, [\\\"Machine catalog\\\"] = Name_s,\\r\\n[\\\"Provisioning type\\\"] = ProvisioningTypeDisplayName,\\r\\n[\\\"Session support\\\"] = SessionSupportDisplayName,\\r\\n[\\\"Allocation type\\\"] = AllocationTypeDisplayName,\\r\\n[\\\"Persistent user changes\\\"] = PersistentUserChangesDisplayName;\\r\\n\\r\\n\\r\\nlet Citrix_Machines = uberAgent_Citrix_Machines_CL\\r\\n| extend isVDA = iff(MachineRole_d in (0, 2), 1, 0)\\r\\n| extend isDDC = iff(MachineRole_d in (1, 2), 1, 0)\\r\\n| extend isRegistered = iff(CurrentRegistrationState_d == 1, 1, 0);\\r\\n\\r\\n\\r\\nlet MachineStats = Citrix_Machines \\r\\n| where isnotempty(SiteGuid_g )\\r\\n| summarize \\r\\n    VDACount = arg_max(TimeGenerated, isVDA),\\r\\n    RegisteredCount = arg_max(TimeGenerated, isRegistered)\\r\\nby CatalogId_g\\r\\n| project CatalogId = CatalogId_g, VDACount = isVDA, RegisteredCount = isRegistered;\\r\\n\\r\\n\\r\\nlet JoinedData = CatalogDetails\\r\\n| join kind=inner (MachineStats) on CatalogId\\r\\n| extend [\\\"%Registered\\\"] = round(RegisteredCount * 100.0 / VDACount, 1)\\r\\n| project \\r\\n    [\\\"Machine catalog\\\"],\\r\\n    [\\\"Session support\\\"],\\r\\n    [\\\"Provisioning type\\\"],\\r\\n    [\\\"Allocation type\\\"],\\r\\n    [\\\"Persistent user changes\\\"],\\r\\n    [\\\"#VDAs\\\"] = iff(isnull(VDACount), 0, VDACount),\\r\\n    [\\\"#Registered\\\"] = iff(isnull(RegisteredCount), 0, RegisteredCount),\\r\\n    [\\\"%Registered\\\"] = iff(isnull([\\\"%Registered\\\"]), 0.0, [\\\"%Registered\\\"])\\r\\n| order by [\\\"Machine catalog\\\"] asc;\\r\\n\\r\\nJoinedData\",\"size\":2,\"title\":\"Machine catalogs\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Machine catalog\",\"exportParameterName\":\"MachineCatalog\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Machine catalog\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}}]}},\"customWidth\":\"50\",\"name\":\"Machine-catalogs\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let DesktopGroupDetails = uberAgent_Citrix_DesktopGroups_CL\\r\\n| where isnotempty(SiteGuid_g) and isnotempty(Id_g)\\r\\n| extend SessionSupportDisplayName = case(SessionSupport_d == 0, \\\"Unknown\\\", \\r\\n                       SessionSupport_d == 1, \\\"SingleSession\\\", \\r\\n                       SessionSupport_d == 2, \\\"MultiSession\\\", \\r\\n                       \\\"NotSupported\\\")\\r\\n| extend DesktopKindDisplayName = case(DesktopKind_d == 0, \\\"Private\\\", \\r\\n                       DesktopKind_d == 1, \\\"Shared\\\", \\r\\n                       \\\"NotSupported\\\")\\r\\n| summarize \\r\\n    arg_max(TimeGenerated, Name_s),\\r\\n    arg_max(TimeGenerated, DesktopKindDisplayName),\\r\\n    arg_max(TimeGenerated, SessionSupportDisplayName),\\r\\n    arg_max(TimeGenerated, IsRemotePC_b)\\r\\n    by Id_g\\r\\n| project \\r\\n    DesktopGroupId = Id_g,\\r\\n    [\\\"Delivery group\\\"] = Name_s,\\r\\n    [\\\"Allocation type\\\"] = DesktopKindDisplayName,\\r\\n    [\\\"Session support\\\"] = SessionSupportDisplayName,\\r\\n    [\\\"Remote PC?\\\"] = IsRemotePC_b;\\r\\n\\r\\n// DesktopGroupDetails\\r\\n\\r\\nlet Citrix_Machines = uberAgent_Citrix_Machines_CL\\r\\n| extend isVDA = iff(MachineRole_d in (0, 2), 1, 0)\\r\\n| extend isDDC = iff(MachineRole_d in (1, 2), 1, 0)\\r\\n| extend isRegistered = iff(CurrentRegistrationState_d == 1, 1, 0);\\r\\n\\r\\n\\r\\nlet MachineStats = Citrix_Machines \\r\\n| where isnotempty(SiteGuid_g )\\r\\n| summarize \\r\\n    VDACount = arg_max(TimeGenerated, isVDA),\\r\\n    RegisteredCount = arg_max(TimeGenerated, isRegistered)\\r\\nby DesktopGroupId_g\\r\\n| project DesktopGroupId = DesktopGroupId_g, VDACount = isVDA, RegisteredCount = isRegistered;\\r\\n\\r\\n// MachineStats\\r\\n\\r\\n\\r\\nlet JoinedData = DesktopGroupDetails\\r\\n| join kind=leftouter MachineStats on DesktopGroupId\\r\\n| extend [\\\"%Registered\\\"] = round(RegisteredCount * 100.0 / VDACount, 1)\\r\\n| project \\r\\n    [\\\"Delivery group\\\"],\\r\\n    [\\\"Session support\\\"],\\r\\n    [\\\"Allocation type\\\"],\\r\\n    [\\\"Remote PC?\\\"],\\r\\n    [\\\"#VDAs\\\"] = iff(isnull(VDACount), 0, VDACount),\\r\\n    [\\\"#Registered\\\"] = iff(isnull(RegisteredCount), 0, RegisteredCount),\\r\\n    [\\\"%Registered\\\"] = iff(isnull([\\\"%Registered\\\"]), 0.0, [\\\"%Registered\\\"])\\r\\n| order by \\\"Delivery group\\\" asc;\\r\\n\\r\\nJoinedData\",\"size\":2,\"title\":\"Delivery groups\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Delivery group\",\"exportParameterName\":\"DeliveryGroup\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Delivery group\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}}]}},\"customWidth\":\"50\",\"name\":\"Delivery-groups\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Citrix_Machines_CL \\r\\n| extend isRegistered = iff(CurrentRegistrationState_d == 1, 1, 0)\\r\\n| where isnotempty(NameHost_s) and CatalogDisplayName_s == \\\"{MachineCatalog}\\\" and isnotempty(SiteGuid_g)\\r\\n| join kind=inner uberAgent_System_MachineInventory_CL on Computer\\r\\n| summarize \\r\\n    arg_max(TimeGenerated, DesktopGroupDisplayName_s),\\r\\n    arg_max(TimeGenerated, isRegistered),\\r\\n    arg_max(TimeGenerated, IsInMaintenanceMode_b),\\r\\n    arg_max(TimeGenerated, EffectiveLoadIndex_d),\\r\\n    arg_max(TimeGenerated, CurrentSessionCount_d),\\r\\n    arg_max(TimeGenerated, CPUCoresLogical_d),\\r\\n    arg_max(TimeGenerated, RAMSizeGB_d),\\r\\n    arg_max(TimeGenerated, HwIsVirtualMachine_b),\\r\\n    arg_max(TimeGenerated, HwHypervisorVendor_s),\\r\\n    arg_max(TimeGenerated, HwModel_s),\\r\\n    arg_max(TimeGenerated, OsVersion_s),\\r\\n    arg_max(TimeGenerated, OsBuild_d),\\r\\n    arg_max(TimeGenerated, AgentVersion_s),\\r\\n    TagsSplit = make_list(Tags_s)\\r\\n    by NameHost_s\\r\\n| extend Tags = strcat_array(TagsSplit, \\\", \\\")\\r\\n| project \\r\\n    Name = NameHost_s,\\r\\n    [\\\"Delivery group\\\"] = DesktopGroupDisplayName_s,\\r\\n    [\\\"Registered?\\\"] = isRegistered,\\r\\n    [\\\"Maint. mode?\\\"] = IsInMaintenanceMode_b,\\r\\n    [\\\"Load index\\\"] = EffectiveLoadIndex_d,\\r\\n    [\\\"#Sessions\\\"] = CurrentSessionCount_d,\\r\\n    [\\\"#CPU cores\\\"] = CPUCoresLogical_d,\\r\\n    [\\\"RAM (GB)\\\"] = RAMSizeGB_d,\\r\\n    [\\\"Is VM?\\\"] = HwIsVirtualMachine_b,\\r\\n    [\\\"Hypervisor\\\"] = HwHypervisorVendor_s,\\r\\n    [\\\"Hardware model\\\"] = HwModel_s,\\r\\n    [\\\"OS version #\\\"] = OsVersion_s,\\r\\n    [\\\"OS build #\\\"] = OsBuild_d,\\r\\n    [\\\"VDA version\\\"] = AgentVersion_s,\\r\\n    Tags\\r\\n\",\"size\":3,\"title\":\"Machine detail: machine catalog = {MachineCatalog}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"workbook\",\"templateIdSource\":\"static\",\"templateId\":\"/subscriptions/6acb58f7-163b-48ff-b133-8c258b4f14da/resourceGroups/krs-rg1/providers/microsoft.insights/workbooks/2b17cd9b-b615-4dff-9215-570bcae0c031\",\"typeSource\":\"workbook\",\"gallerySource\":\"workbook\",\"locationSource\":\"workbook\",\"workbookName\":\"Details\",\"passSpecificParams\":true,\"templateParameters\":[{\"name\":\"MachineName\",\"source\":\"column\",\"value\":\"Name\"},{\"name\":\"TimeRange\",\"source\":\"parameter\",\"value\":\"TimeRange\"}],\"viewerMode\":false}}}]}},\"conditionalVisibility\":{\"parameterName\":\"MachineCatalog\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 9\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Citrix_Machines_CL \\r\\n| extend isRegistered = iff(CurrentRegistrationState_d == 1, 1, 0)\\r\\n| where isnotempty(NameHost_s) and DesktopGroupDisplayName_s == \\\"{DeliveryGroup}\\\" and isnotempty(SiteGuid_g)\\r\\n| join kind=inner uberAgent_System_MachineInventory_CL on Computer\\r\\n| summarize \\r\\n    arg_max(TimeGenerated, CatalogDisplayName_s),\\r\\n    arg_max(TimeGenerated, isRegistered),\\r\\n    arg_max(TimeGenerated, IsInMaintenanceMode_b),\\r\\n    arg_max(TimeGenerated, EffectiveLoadIndex_d),\\r\\n    arg_max(TimeGenerated, CurrentSessionCount_d),\\r\\n    arg_max(TimeGenerated, CPUCoresLogical_d),\\r\\n    arg_max(TimeGenerated, RAMSizeGB_d),\\r\\n    arg_max(TimeGenerated, HwIsVirtualMachine_b),\\r\\n    arg_max(TimeGenerated, HwHypervisorVendor_s),\\r\\n    arg_max(TimeGenerated, HwModel_s),\\r\\n    arg_max(TimeGenerated, OsVersion_s),\\r\\n    arg_max(TimeGenerated, OsBuild_d),\\r\\n    arg_max(TimeGenerated, AgentVersion_s),\\r\\n    TagsSplit = make_list(Tags_s)\\r\\n    by NameHost_s\\r\\n| extend Tags = strcat_array(TagsSplit, \\\", \\\")\\r\\n| project \\r\\n    Name = NameHost_s,\\r\\n    [\\\"Machine catalog\\\"] = CatalogDisplayName_s,\\r\\n    [\\\"Registered?\\\"] = isRegistered,\\r\\n    [\\\"Maint. mode?\\\"] = IsInMaintenanceMode_b,\\r\\n    [\\\"Load index\\\"] = EffectiveLoadIndex_d,\\r\\n    [\\\"#Sessions\\\"] = CurrentSessionCount_d,\\r\\n    [\\\"#CPU cores\\\"] = CPUCoresLogical_d,\\r\\n    [\\\"RAM (GB)\\\"] = RAMSizeGB_d,\\r\\n    [\\\"Is VM?\\\"] = HwIsVirtualMachine_b,\\r\\n    [\\\"Hypervisor\\\"] = HwHypervisorVendor_s,\\r\\n    [\\\"Hardware model\\\"] = HwModel_s,\\r\\n    [\\\"OS version #\\\"] = OsVersion_s,\\r\\n    [\\\"OS build #\\\"] = OsBuild_d,\\r\\n    [\\\"VDA version\\\"] = AgentVersion_s,\\r\\n    Tags\",\"size\":3,\"title\":\"Machine detail: delivery group = {DeliveryGroup}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"workbook\",\"templateIdSource\":\"static\",\"templateId\":\"<<<REPLACEHERE>>>\",\"typeSource\":\"workbook\",\"gallerySource\":\"workbook\",\"locationSource\":\"workbook\",\"workbookName\":\"Machine Details\",\"passSpecificParams\":true,\"templateParameters\":[{\"name\":\"MachineName\",\"source\":\"column\",\"value\":\"Name\"},{\"name\":\"TimeRange\",\"source\":\"parameter\",\"value\":\"TimeRange\"}],\"viewerMode\":false}}}]}},\"conditionalVisibility\":{\"parameterName\":\"DeliveryGroup\",\"comparison\":\"isNotEqualTo\"},\"name\":\"DeliveryGroupDetails\",\"styleSettings\":{\"showBorder\":true}}]},\"name\":\"group - MachineCatalog\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"uberAgent_Citrix_Machines_CL\\r\\n| extend isVDA = iff(MachineRole_d in (0, 2), 1, 0)\\r\\n| extend isDDC = iff(MachineRole_d in (1, 2), 1, 0)\\r\\n| extend isRegistered = iff(CurrentRegistrationState_d == 1, 1, 0)\\r\\n| extend FaultStateDisplayName = case(FaultState_d == 0, \\\"Unknown\\\", \\r\\n                       FaultState_d == 1, \\\"None\\\", \\r\\n                       FaultState_d == 2, \\\"FailedToStart\\\",\\r\\n                       FaultState_d == 3, \\\"StuckOnBoot\\\",\\r\\n                       FaultState_d == 4, \\\"Unregistered\\\", \\r\\n                       FaultState_d == 5, \\\"MaxCapacity\\\",\\r\\n                       \\\"NotSupported\\\")\\r\\n| where isRegistered == 0 and isDDC == 0 and isnotempty(SiteGuid_g) and isnotempty(NameHost_s)\\r\\n| summarize \\r\\n    arg_max(TimeGenerated, IsInMaintenanceMode_b),\\r\\n    arg_max(TimeGenerated, SiteName_s),\\r\\n    arg_max(TimeGenerated, CatalogDisplayName_s),\\r\\n    arg_max(TimeGenerated, DesktopGroupDisplayName_s),\\r\\n    arg_max(TimeGenerated, FaultStateDisplayName),\\r\\n    arg_max(TimeGenerated, LastDeregisteredCode_d),\\r\\n    arg_max(TimeGenerated, LastDeregisteredDate_s),\\r\\n    arg_max(TimeGenerated, RegistrationStateChangeDate_s),\\r\\n    arg_max(TimeGenerated, AgentVersion_s),\\r\\n    arg_max(TimeGenerated, Sid_s),\\r\\n    arg_max(TimeGenerated, CatalogId_g),\\r\\n    arg_max(TimeGenerated, DesktopGroupId_g)\\r\\n    by Name_s\\r\\n| project \\r\\n    [\\\"Name\\\"] = Name_s,\\r\\n    [\\\"Maint. mode?\\\"] = IsInMaintenanceMode_b,\\r\\n    [\\\"Site\\\"] = SiteName_s,\\r\\n    [\\\"Machine catalog\\\"] = CatalogDisplayName_s,\\r\\n    [\\\"Delivery group\\\"] = DesktopGroupDisplayName_s,\\r\\n    [\\\"Fault state\\\"] = FaultStateDisplayName,\\r\\n    [\\\"Last deregistered code\\\"] = LastDeregisteredCode_d,\\r\\n    [\\\"Last deregistered date\\\"] = LastDeregisteredDate_s,\\r\\n    [\\\"Registration change date\\\"] = RegistrationStateChangeDate_s,\\r\\n    [\\\"VDA version\\\"] = AgentVersion_s,\\r\\n    [\\\"Sid\\\"] = Sid_s\",\"size\":2,\"title\":\"Unregistered machines\",\"noDataMessage\":\"No results found.\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"name\":\"query - 8\"}]},\"name\":\"group - Unregistered\",\"styleSettings\":{\"showBorder\":true}}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/6acb58f7-163b-48ff-b133-8c258b4f14da/resourceGroups/KRS-RG1/providers/Microsoft.OperationalInsights/workspaces/uberAgentWS\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}